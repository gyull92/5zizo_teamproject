<!DOCTYPE html>
<html lang="en">
<head>
    <title>ì¥ë°”êµ¬ë‹ˆ ì¡°íšŒ</title>

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" 
        crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
        integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l"
        crossorigin="anonymous">

    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
        integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
        crossorigin="anonymous"></script>

    <!-- style -->
    <style type="text/css">
        body {
            font-family: "Helvetica";
        }
        .navbar{
        height: 60px;
        padding-left: 30px;
        }

        .logo{
        line-height: 60px;
        float: left;
        }

        .logo img{
        vertical-align: middle;
        }

        .navbar ul{
        float: right;
        }

        .navbar li{
        list-style-type: none;
        float: left;
        margin-right: 30px;
        }

        .navbar a{
        text-decoration: none;
        color: black;
        font-style: bold;
        font-size: 13px;
        }

        .table {
            width: 70%;
            margin: auto;
        }

        td > img {
            width: 75px;
            height: 75px;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        .modQuantity {
            width: 40px;
            margin-right: 10px;
        }

        table > button {
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        #Bnts {
            margin-left: 200px;
            margin-bottom: 5px;
            margin-top: 5px;
        }

        .card {
            width: 50%;
            margin: auto;
            margin-top: 50px;
            text-align: right;
        }
        #navButton {
            margin-top:  3px;
            margin-left: 5px;
        }

        #navName {
            margin-top:  10px;
        }

        #cartTitle {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 4%;
        }
        img {
            object-fit: contain;
        }
    </style>

    <script>
        $(document).ready(function () {
            showProductsInCart();
        });

        function showProductsInCart() {
            $("#products-in-carts").html("");
            $.ajax({
                    type: "GET",
                    url: "/general/cartList/",
                    data: {},
                    success: function (response) {
                        console.log("response------", response)
                        let productsInCart = response["cart"];
                        console.log("productsInCart------", productsInCart)
                        let productIdList = [];
                        console.log("productIdList------", productIdList)
                        for (let i = 0; i < productsInCart.length; i++) {
                            let image = productsInCart[i].products.image;
                            let imgsrc = "../static/images/" + image
                            let name = productsInCart[i].products.name;
                            let price = productsInCart[i].products.price;
                            let quantity = productsInCart[i].quantity;
                            let productId = productsInCart[i].products.productId;
                            productIdList.push(productId);
                            
                            makeCart(imgsrc, name, price, quantity, productId);
                        }
                        window.localStorage.setItem('productIdList', productIdList);
                        if (productsInCart.length){
                            makeBnt();
                        }
                    }
                });
            }

        let totalPrice = 0;
        let totalQuantity = 0;
        function makeCart(image, name, price, quantity, productId) {
            let subPrice = price * quantity;
            totalPrice  += subPrice;
            totalQuantity += quantity;
            let tempHtml = `<tr>
                <th scope="row"><input id="check-box-${productId}" type="checkbox" aria-label="Checkbox for following text input"></th>
                <td><img src="${image}"></td>
                <td>${name}</td>
                <td>${price.toLocaleString('ko-KR')}ì›</td>
                <td><input id="modQuantity-${productId}" class="modQuantity" type="number" min="0" value="${quantity}" /><button onclick="editQuantity(${productId})" type="button" class="btn btn-outline-dark">ìˆ˜ëŸ‰ë³€ê²½</button></td>
                <td>${subPrice.toLocaleString('ko-KR')}ì›</td>
                <td><button onclick="deleteProduct(${productId})" type="button" class="btn btn-outline-success">ì‚­ì œ</button></td>
            </tr>`;
            $("#products-in-carts").append(tempHtml);

            if(totalPrice>0){
                makeBillCard(totalPrice, totalQuantity);
            }
        }

        function makeBillCard(totalPrice, totalQuantity) {
            $("#orderCard").html("");
            let tempHtml = `<div class="card-body">
                        <h5 class="card-title">í•©ê³„ ê¸ˆì•¡ : ${totalPrice.toLocaleString('ko-KR')}ì›</h5>
                        <p class="card-text">ìƒí’ˆ ê°¯ìˆ˜ : ${totalQuantity}ê°œ</p>
                        <button href="#" class="btn btn-outline-success">ë°”ë¡œ êµ¬ë§¤í•˜ê¸°</button>
                        </div>`
            $("#orderCard").append(tempHtml);
        }

        function makeBnt() {
            let tempHtml = `<button onclick="deleteSelectedProduct()" type="button" class="btn btn-outline-success">ì„ íƒí•­ëª© ì‚­ì œ</button>
                            <button onclick="deleteAllProduct()" type="button" class="btn btn-outline-success">ì „ì²´ ì‚­ì œ</button>`
            $("#Bnts").append(tempHtml);
        }

        function deleteSelectedProduct() {
            let testList = window.localStorage.getItem('productIdList').split(',')

            let delArray = []

            for(let i=0; i<testList.length; i++){
                if($(`#check-box-${testList[i]}`).is(":checked") === true){
                    delArray.push(testList[i]);
                }
            }

            $.ajax({
                    type: "DELETE",
                    url: "/general/del/checked",
                    traditional: true,	// ajax ë°°ì—´ ë„˜ê¸°ê¸° ì˜µì…˜!
                    data: { "checkedList" : delArray },
                    success: function (response) {
                        if (response['result'] == 'success') {
                            alert('ì„ íƒ í•­ëª© ì‚­ì œ ì™„ë£Œ!');
                            window.location.reload();
                        }
                    }
                });
        }

        function deleteAllProduct() {
            $.ajax({
                    type: "DELETE",
                    url: "/general/cart",
                    data: { },
                    success: function (response) {
                        if (response['result'] == 'success') {
                            alert('ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê¸° ì™„ë£Œ!');
                            window.location.reload();
                        }
                    }
                });
        }


        function editQuantity(productId) {
            let modQuantity = $(`#modQuantity-${productId}`).val();
            $.ajax({
                    type: "PATCH",
                    url: "/general/cart/" + productId,
                    data: { modQuantity },
                    success: function (response) {
                        if (response['result'] == 'success') {
                            alert('ìˆ˜ëŸ‰ ìˆ˜ì • ì™„ë£Œ!');
                            window.location.reload();
                        }
                    }
                });
        }

        function deleteProduct(productId) {
            $.ajax({
                    type: "DELETE",
                    url: "/general/cart/" + productId,
                    data: { },
                    success: function (response) {
                        if (response['result'] == 'success') {
                            alert('ì‚­ì œ ì™„ë£Œ!');
                            window.location.reload();
                        }
                    }
                });
        }
    </script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">ğŸ’œ ì˜¤ì§€ëŠ” ì ¤ë¦¬ ğŸ’š</a>
    
            <!-- <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button> -->

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <!-- <a class="nav-link " aria-current="page" href="#">í™ˆ</a> -->
                    </li>
                </ul>

                <div class="navbar">
                    <!-- <a class="logo" href="#"> </a> -->
                    <ul>
                      <% if (user) { %>      
                          <li id="navName">ğŸ¥ Hello <%= user.email.split('@')[0] %></li>        
                          <button id="navButton" type="button" onclick="location.href='/profile'"      class="btn btn-outline-success">My Page</button> 
                          <button id="navButton" type="button" onclick="location.href='/auth/logout'"  class="btn btn-outline-success">Logout</button> 
                        <% } %>
                    </ul>

                  </div>
            </div>
        </div>
    </nav>

    <h1 id="cartTitle">ğŸ‡ğŸ“ğŸ¥ CartList ğŸ¥ğŸ“ğŸ‡</h1>

      <table class="table">
        <thead>
          <tr>
            <th scope="col">ì„ íƒ</th>
            <th scope="col">ì´ë¯¸ì§€</th>
            <th scope="col">ìƒí’ˆëª…</th>
            <th scope="col">ê°€ê²©</th>
            <th scope="col">ìˆ˜ëŸ‰</th>
            <th scope="col">í•©ê³„</th>
            <th scope="col">ì‚­ì œ</th>
          </tr>
        </thead>
        <tbody id="products-in-carts">
          
        </tbody>
        
      </table>

      <div id="Bnts"></div>

      <div id="orderCard" class="card">

      </div>


    
</body>
</html>